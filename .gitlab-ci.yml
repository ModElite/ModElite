stages:
  - format
  - eslint
  - build

image: node:latest

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

format:
  stage: format
  script:
    - yarn
    - yarn format
    - git checkout -B $CI_COMMIT_REF_NAME  # Checkout the branch explicitly
    - |
      if ! git diff --exit-code; then
        git config --global user.email "ci@git.cpe.kmutt.ac.th"
        git config --global user.name "CI Bot - [Zuck-my-clothe]"
        git add .
        git commit -m "Format Code"
        git push https://gitlab-ci-token:$CI_ACCESSTOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git $CI_COMMIT_REF_NAME
      else
        echo "No changes For Prettier Format"
      fi

eslint:
  stage: eslint
  dependencies:
    - format
  needs:
    - format
  cache:
    policy: pull
  script:
    - if [ ! -d "node_modules" ]; then yarn install; fi
    - yarn
    - yarn format
    - yarn lint

build:
  stage: build
  dependencies:
    - eslint
  needs:
    - eslint
  cache:
    policy: pull
  script:
    - if [ ! -d "node_modules" ]; then yarn install; fi
    - yarn build
